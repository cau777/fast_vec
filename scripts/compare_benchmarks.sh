#!/bin/bash

# Quick version of run_benchmarks.sh that doesn't run benchmarks
# Useful for testing the script logic without waiting for full benchmarks

CRITERION_DIR="target/criterion"

echo "Generating comparison tables (using existing benchmark results)..."
echo ""

generate_system_specs() {
    echo "### System Specifications"
    echo ""

    # Gather specs
    local cpu_model=""
    local cpu_cores=""
    local ram=""
    local os=""
    local rust_version=""
    local date=""

    if [ -f /proc/cpuinfo ]; then
        cpu_model=$(grep -m1 'model name' /proc/cpuinfo | sed 's/model name\t: //')
        cpu_cores=$(nproc)
    fi

    ram=$(free -h | awk '/^Mem:/ {print $2}')

    if [ -f /etc/os-release ]; then
        os=$(grep PRETTY_NAME /etc/os-release | cut -d'"' -f2)
    fi

    rust_version=$(rustc --version 2>/dev/null || echo 'Not available')
    date=$(date -u '+%Y-%m-%d %H:%M:%S UTC')

    # Output as table
    echo "| Specification | Value |"
    echo "|---------------|-------|"
    echo "| CPU | $cpu_model |"
    echo "| Cores | $cpu_cores |"
    echo "| RAM | $ram |"
    echo "| OS | $os |"
    echo "| Rust | $rust_version |"
    echo "| Date | $date |"

    echo ""
}

generate_table() {
    local vec_type="$1"
    local title="$2"
    local dim="$3"

    echo "### $title"
    echo ""
    echo "| Operation | fast_vec (ns) | nalgebra (ns) | Speedup |"
    echo "|-----------|--------------|---------------|---------|"

    # Get all unique operations for this vector type
    local operations=$(ls "$CRITERION_DIR" 2>/dev/null | grep "^fast_vec${dim}_" | sed "s/^fast_vec${dim}_//" | sort)

    if [ -z "$operations" ]; then
        echo "| (No benchmarks found) | | | |"
        return
    fi

    for op in $operations; do
        local fast_json="$CRITERION_DIR/fast_vec${dim}_${op}/new/estimates.json"
        local nalg_json="$CRITERION_DIR/nalgebra${dim}_${op}/new/estimates.json"

        if [ -f "$fast_json" ] && [ -f "$nalg_json" ]; then
            local fast_time=$(jq -r '.mean.point_estimate' "$fast_json" 2>/dev/null)
            local nalg_time=$(jq -r '.mean.point_estimate' "$nalg_json" 2>/dev/null)

            if [ -n "$fast_time" ] && [ "$fast_time" != "null" ] &&
               [ -n "$nalg_time" ] && [ "$nalg_time" != "null" ]; then

                if (( $(echo "$fast_time > 0" | bc -l) )); then
                    local speedup=$(echo "scale=2; $nalg_time / $fast_time" | bc -l)
                    printf "| %-20s | %12.2f | %13.2f | %7.2fx |\n" "$op" "$fast_time" "$nalg_time" "$speedup"
                fi
            fi
        fi
    done
    echo ""
}

# Output to terminal
generate_table "Vector2" "Vector2 Benchmarks" "2"
generate_table "Vector3" "Vector3 Benchmarks" "3"

echo "Results saved to BENCHMARK_RESULTS.md"

# Also save to markdown file
{
    echo "# Benchmark Results"
    echo ""
    echo "Comparison between \`fast_vec\` SIMD implementation and \`nalgebra\`"
    echo ""
    echo "Generated by \`scripts/compare_benchmarks.sh\`"
    echo ""

    generate_system_specs

    generate_table "Vector2" "Vector2 Benchmarks" "2"
    generate_table "Vector3" "Vector3 Benchmarks" "3"
} > BENCHMARK_RESULTS.md

echo "Done!"
