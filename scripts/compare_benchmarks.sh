#!/bin/bash

set -e

echo "Running benchmarks..."
cargo bench --bench vec3_bench

echo ""
echo "Generating comparison table..."
echo ""
echo "| Operation | fast_vec (ns) | nalgebra (ns) | Speedup |"
echo "|-----------|--------------|---------------|---------|"

operations=("new" "zeros" "add" "sub" "mul_scalar" "div_scalar" "neg" "dot" 
            "magnitude_squared" "magnitude" "normalize" "cross" "distance" 
            "distance_squared" "getters" "setters")

for op in "${operations[@]}"; do
    fast_json="target/criterion/${op}/fast_vec/new/estimates.json"
    nalg_json="target/criterion/${op}/nalgebra/new/estimates.json"
    
    if [ -f "$fast_json" ] && [ -f "$nalg_json" ]; then
        fast_time=$(jq -r '.mean.point_estimate' "$fast_json" 2>/dev/null)
        nalg_time=$(jq -r '.mean.point_estimate' "$nalg_json" 2>/dev/null)
        
        if [ -n "$fast_time" ] && [ "$fast_time" != "null" ] && 
           [ -n "$nalg_time" ] && [ "$nalg_time" != "null" ]; then
            
            if (( $(echo "$fast_time > 0" | bc -l) )); then
                speedup=$(echo "scale=2; $nalg_time / $fast_time" | bc -l)
                printf "| %-20s | %12.2f | %13.2f | %7.2fx |\n" "$op" "$fast_time" "$nalg_time" "$speedup"
            fi
        fi
    fi
done

echo ""
echo "Results saved to BENCHMARK_RESULTS.md"

# Also save to markdown file
{
    echo "# Benchmark Results"
    echo ""
    echo "Comparison between \`fast_vec\` SIMD implementation and \`nalgebra\` Vector3<f64>"
    echo ""
    echo "| Operation | fast_vec (ns) | nalgebra (ns) | Speedup |"
    echo "|-----------|--------------|---------------|---------|"
    
    for op in "${operations[@]}"; do
        fast_json="target/criterion/${op}/fast_vec/new/estimates.json"
        nalg_json="target/criterion/${op}/nalgebra/new/estimates.json"
        
        if [ -f "$fast_json" ] && [ -f "$nalg_json" ]; then
            fast_time=$(jq -r '.mean.point_estimate' "$fast_json" 2>/dev/null)
            nalg_time=$(jq -r '.mean.point_estimate' "$nalg_json" 2>/dev/null)
            
            if [ -n "$fast_time" ] && [ "$fast_time" != "null" ] && 
               [ -n "$nalg_time" ] && [ "$nalg_time" != "null" ]; then
                
                if (( $(echo "$fast_time > 0" | bc -l) )); then
                    speedup=$(echo "scale=2; $nalg_time / $fast_time" | bc -l)
                    printf "| %-20s | %12.2f | %13.2f | %7.2fx |\n" "$op" "$fast_time" "$nalg_time" "$speedup"
                fi
            fi
        fi
    done
    echo ""
    echo "Generated by \`scripts/compare_benchmarks.sh\`"
} > BENCHMARK_RESULTS.md

echo "Done!"
